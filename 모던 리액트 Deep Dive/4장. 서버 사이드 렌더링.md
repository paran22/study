## 4장. 서버 사이드 렌더링

### 4.1 서버 사이드 렌더링이란?

- 싱글 페이지 애플리케이션(SPA)
  - 렌더링과 라우팅에 필요한 대부분의 기능을 서버가 아닌 브라우저의 자바스크립트에 의존하는 방식
  - 페이지를 불러온 이후에는 서버에서 HTML을 내려받지 않고 하나의 페이지에서 모든 작업을 처리함
  - 최초 로딩해야하는 자바스크립트 리소스가 커지지만, 한번 로딩된 이후에는 서버를 거쳐 필요한 리소스를 받아올 일이 적어서 ux가 향상된다.
  - 서버 리소스를 적게 사용하기 때문에 서버 확장성 문제에서 비교적 자유롭다.
  - 사용자의 기기와 인터넷 속도 등 웹 전반 환경이 크게 개선됐음에도 실제 사용자들이 느끼는 웹 애플리케이션의 로딩 속도는 크게 차이가 없다는 점은, 개발자로써 책임감을 가질 필요가 있다.
- 서버사이드 렌더링
  - 장점
    - 최초에 사용자에게 보여줄 페이지를 서버에서 렌더링해 제공한다.
    - 사용자 기기 성능에 영향을 받는 클라이언트 사이드 렌더링에 비해 비해 안정적이다.
    - 일반적으로 서버에서 HTTP 요청을 수행하는 것이 더 빠르고, 서버에서 HTML을 문자열로 미리 그려서 내려주는 것이 클라이언트에서 기존 HTML에 삽입하는 것보다 더 빠르기 때문에 최초 페이지 진입 후 페이지에 유의미한 정보가 그려지는 시간(First Contentful Paint)가 더 빠르다.
    - 다운로드한 HTML 페이지 내부에 open graph나 meta 태그 정보를 삽입할 수 있어 검색 엔진 최적화에 유리하다.
    - 사용자에게 페이지를 보여준 이후에 HTML에 정보가 추가되거나 삭제되는 누적 레이아웃 이동(Cumulative Layout Shift)을 줄일 수 있다.
    - 사용자 디바이스 성능으로부터 자유롭다.
    - 민감한 정보는 브라우저에 노출하지 않을 수 있다.
  - 단점
    - window, sessionStorage 등 브라우저에만 있는 전역 객체를 사용할 수 없다.
    - 적절한 서버 구축이 필요하다.
    - 서버에서 사용자에게 보여줄 페이지에 대한 렌더링 작업이 끝나기까지는 사용자에게 어떤 정보도 제공할 수 없다.
- 가장 뛰어난 싱글 페이지 애플리케이션은 가장 뛰어난 멀티 페이지 애플리케이션보다 낫다.
- 평균적인 노력을 기울여서 동일한 서비스를 만든다면 서버에서 렌더링되는 멀티 페이지 애플리케이션이 더 우위일 수 있다.
- 현대의 서버사이드 렌더링은 최초 웹사이트 진입 시에는 서버사이드 렌더링 방식으로 서버에서 완성된 HTML을 제공받고, 이후 라우팅에서는 서버에서 내려받은 싱글 페이지 애플리케이션처럼 작동한다.

### 4.2 서버 사이드 렌더링을 위한 리액트 API 살펴보기

#### renderToString

- 인수로 넘겨받은 리엑트 컴포넌트를 렌더링해 HTML 문자열로 반환하는 함수
- 클라이언트에서 실행되는 자바스크립트 코드를 포함시키거나 렌더링하는 역할까지 해주지는 않는다.
- 실제로 웹페이지가 사용자와 인터렉션할 준비가 되기 위해서는 별도의 자바스크립트 코드를 다운로드, 파싱, 실행하는 과정을 거쳐야 한다.
- div#root에 존재하는 data-reactroot를 통해 이후 자바스크립트를 실행하기 위한 hydrate 함수에서 루트를 식별하는 기준점이 된다.

#### renderToStaticMarkup

- renderToString과 달리 data-reactroot와 같이 리엑트에서만 사용하는 추가적인 DOM 속성을 만들지 않아서, HTML의 크기가 약간 줄어든다.
- 리엑트에서 제공하는 브라우저 API를 절대로 실행할 수 없다.
- 리엑트의 이벤트 리스너가 필요 없는 완전히 순수한 HTML을 만들 때만 사용된다.

#### renderToNodeStream

- 함수 실행의 결과물이 Node.js의 ReadableStream이기 때문에 서버 환경에서만 실행할 수 있고 브라우저에서는 사용할 수 없다.
- 스트림은 큰 데이터를 다룰 때 데이터를 청크(chunk, 작은 단위)로 분할해 조금씩 가져오는 방식을 취하기 때문에 렌더링하는 Node.js 서버의 부담을 덜 수 있다.
- 대부분의 널리 알려진 리엑트 서버 사이드 렌더링 프레임워크는 모두 renderToString 대신 renderToStream을 채택하고 있다.

#### renderToStaticNodeStream

- renderToNodeStream과 제공하는 결과물은 동일하나, 리엑트 속성이 제공되지 않는다.

#### hydrate

- renderToString과 renderToNodeStream으로 생성된 HTML 콘텐츠에 자바스크립트 핸들러나 이벤트를 붙이는 역할을 한다.
- render 함수는 컴포넌트와 HTML의 요소를 인수로 받아 HTML의 요소에 해당 컴포넌트를 렌더링하며, 여기에 이벤트 핸들러를 붙이는 작업까지 모두 한 번에 수행한다. 클라이언트에서만 실행된다.
- hydrate는 이미 렌더링된 HTML이 있다는 가정하에 작업이 수행되고, 이 렌더링된 HTML을 기준으로 이벤트를 붙이는 작업만 실행한다.
- 서버에서 렌더링한 정보가 없다면 경고가 표시되지만 hydrate가 렌더링을 한 번 수행하면서 hydrate가 수행한 렌더링 결과물 HTML와 인수로 넘겨받은 HTML을 비교하는 작업을 수행하기 때문에 정상적으로 웹페이지를 만든다.
  - 그렇지만 이렇게 렌더링하는 것은 사실상 서버와 클라이언트에서 두 번 렌더링을 하는 것이기 때문에 서버 사이드 렌더링의 장점을 살릴 수 없어 권장하지 않는다.
